<template>
    <div>
        <table-default
            ref="table"
            :columns="columns"
            :config="tableConfig"
            :show-columns="false"
            searchType="date"
            searchable
            hover            
            boxed
        >
            <template slot="tableHeadActions" v-if="!myTeam">
                <b-button 
                    @click="$bvModal.show('modal-leave-days')"
                    variant="outline-primary" 
                    size="sm" 
                    class="p-2"
                    v-if="!forHrm"
                >
                    Create
                </b-button>
            </template>
            <template slot="tableHeadForms" v-if="forHrm">
                <form-input-group class="d-none d-xl-block d-lg-block search-form mr-2">
                    <b-form-input style="min-width: 285px;" placeholder="Search by ID or Name..." v-model.lazy="q"></b-form-input>
                    <template #append>
                        <span class="h3">
                            <q-icon icon="bx:search-alt"/>
                        </span>
                    </template>
                </form-input-group>
            </template>
            <template slot="row-user_id" slot-scope="{row}">
                <div v-if="forHrm">
                    <div>{{ row.user ? row.user.username : 'N/A' }}</div>
                    <div>{{ row.user ? row.user.fullname : 'N/A' }}</div>
                </div>
            </template>
            <template slot="row-type" slot-scope="{row}">
                {{ getTypeLabel(row.type) }}
            </template>
            <template #row-reason="{row}">
                <read-more 
                    class="read-more" 
                    more-str="show more" 
                    :text="row.reason" 
                    link="#" 
                    less-str="show less" 
                    :max-chars="30"
                />                
            </template>
            <template slot="row-status" slot-scope="{row}">
                <div class="w-100 d-flex justify-content-between" v-if="!myTeam">
                    <div class="text-info" v-if="row.status == 'pending' || row.status == 'draft'">
                        Waiting for approval
                    </div>
                    <div class="text-success" v-if="row.status == 'approved'">
                        Approved by 
                        <u class="text-cursor" v-b-tooltip.html="showApproverDetail(row.approver)">
                            {{ row.approver ? (row.approver.fullname || 'N/A') : 'N/A' }}
                        </u>
                    </div>
                    <div class="text-danger" v-if="row.status == 'cancel'">
                        Canceled
                    </div>
                    <div 
                        class="text-cursor text-danger" 
                        v-if="row.status == 'pending' || row.status == 'draft'" 
                        @click="cancelLeaveDay(row.id)"
                        v-show="!forHrm"
                    >
                        <u>Cancel</u>
                    </div>
                </div>
                <div class="w-100 d-flex justify-content-between" v-else>
                    <div class="text-info" v-if="row.status == 'pending' || row.status == 'draft'">
                        Waiting for approval
                    </div>
                    <div class="text-success" v-if="row.status == 'approved'">
                        Approved 
                    </div>                    
                    <div class="d-flex">
                        <div 
                            class="text-cursor text-success font-weight-bold mr-3" 
                            v-if="row.status == 'pending' || row.status == 'draft'" 
                            @click="approveLeaveDay(row.id)"
                            v-show="!forHrm"
                        >
                            <u>Approve</u>
                        </div>                    
                        <div 
                            class="text-cursor text-danger" 
                            v-if="row.status == 'pending' || row.status == 'draft'" 
                            @click="cancelLeaveDay(row.id)"
                            v-show="!forHrm"
                        >
                            <u>Cancel</u>
                        </div>                    
                    </div>                    
                </div>
            </template>
        </table-default>
        <b-modal id="modal-leave-days" size="xl" hide-header hide-footer @hide="modalData = null">
            <div class="p-3">
                <modal-custom-header modal-id="modal-leave-days" title="CREATE"/>
                <FormLeaveDay @created="refreshTable"/>
            </div>
        </b-modal>            
    </div>
</template>

<script>
    import FormLeaveDay from './Form.vue'

    export default {
        name: 'TableLeaveDays',
        props: {
            forHrm: {
                type: Boolean,
                default: false
            },

            myTeam: {
                type: Boolean,
                default: false
            },
        },

        components: {FormLeaveDay},

        data: () => ({
            modalData: null,
            q: '',
            typeOptions: [
                {label: 'Paid Leave - Nghỉ có lương', value: 'paid_leave'},
                {label: 'Unpaid Leave - Nghỉ không lương', value: 'unpaid_leave'},
                {label: 'Paternity Leave - Nghỉ thai sản', value: 'paternity_leave'},
                {label: 'Marriage Leave - Nghỉ đám cưới', value: 'marriage_leave'},
                {label: 'Sick Leave - Nghỉ bệnh', value: 'sick_leave'}
            ]            
        }),

        computed: {
            tableConfig() {
                return {
                    url: this.myTeam ? 'annual-leave/my-team' : `annual-leave${this.forHrm ? '/list' : ''}`,
                    per_page: 12,
                    params: {
                        status: this.forHrm ? 'approved' : '',
                        q: this.q
                    }
                }
            },

            columns() {
                const addition = []
                const cols = [
                    {label: "From", name: "start_date"},
                    {label: "To", name: "end_date"},
                    {label: "Total day", name: "total_day"},
                    {label: "Type", name: "type"},
                    {label: "Reason", name: "reason"},
                    {label: "Status", name: "status", display: 'none', rowWidth: '100%'},         
                ]

                if(this.forHrm) {
                    addition.push({label: "User", name: "user_id"})                    
                }

                return [].concat(addition, cols)
            }
        },

        methods: {
            handleEditClicked() {

            },

            getTypeLabel(val) {
                const type = this.typeOptions.find(x => x.value == val)

                return type ? type.label : 'N/A'
            },

            cancelLeaveDay(id) {
                this.$showAlert({
                    type: 'confirm',
                    title: "Warning!",
                    message: 'Do you really want to cancel this request?<br/>This process cannot be undone.',
                    callback: async ({dismiss}) => {
                        try {
                            const { data } = await this.$http.patch('annual-leave/cancel/' + id)

                            if(!data.error) {
                                dismiss(true)
                                this.$refs.table.refresh(true)

                                this.$showAlert({
                                    type: 'success',
                                    message: 'Canceled leave day successfully'
                                })
                            }
                        } catch (err) {
                            console.log(err)
                            this.$showAlert({
                                type: 'danger',
                                message: 'Something went wrong, please try again later'
                            })                    
                        }
                    }
                })
            },

            approveLeaveDay(id) {
                this.$showAlert({
                    type: 'confirm',
                    title: "Warning!",
                    message: 'Do you really want to approve this request?<br/>This process cannot be undone.',
                    callback: async ({dismiss}) => {
                        try {
                            const { data } = await this.$http.patch('annual-leave/approved/' + id)

                            if(!data.error) {
                                dismiss(true)
                                this.$refs.table.refresh(true)

                                this.$showAlert({
                                    type: 'success',
                                    message: 'Canceled leave day successfully'
                                })
                            }
                        } catch (err) {
                            console.log(err)
                            this.$showAlert({
                                type: 'danger',
                                message: 'Something went wrong, please try again later'
                            })                    
                        }
                    }
                })
            },

            refreshTable() {
                this.$refs.table.refresh(true)    
                this.$bvModal.hide('modal-leave-days')
            },

            showApproverDetail(approver) {
                const user = approver || {}

                return `<ul class="p-0 h5 mb-0">
                    <li>Code: ${user.username || 'N/A'}</li>
                    <li>Name: ${user.fullname || 'N/A'}</li>
                    <li>Phone: ${user.phone || 'N/A'}</li>
                </ul>`
            }
        }
    }
</script>

<style lang="scss" scoped>

</style>